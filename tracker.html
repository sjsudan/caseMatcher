<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal File Tracker v5 (Stable)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .slide-in { animation: slideIn 0.2s ease-out; }
        @keyframes slideIn { from { transform: translateY(5px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-2 md:p-6 text-slate-800">

    <div class="max-w-xl mx-auto bg-white shadow-xl rounded-2xl overflow-hidden border border-slate-200 flex flex-col h-[90vh]">
        
        <!-- Header -->
        <div class="bg-indigo-900 p-4 text-white flex justify-between items-center shadow-md shrink-0">
            <div>
                <h1 class="text-lg font-bold tracking-wide flex items-center gap-2">
                    <!-- Icon Placeholder -->
                    <span id="headerIcon">ðŸ“‚</span> Legal Tracker
                </h1>
                <p class="text-indigo-200 text-[10px] uppercase tracking-wider">Stable Version v5</p>
            </div>
            <button onclick="clearData()" class="text-xs bg-indigo-800 hover:bg-red-500 text-white px-3 py-1.5 rounded transition-colors duration-200 border border-indigo-700">Reset All</button>
        </div>

        <!-- Import Section -->
        <div class="p-4 bg-indigo-50 border-b border-indigo-100 shrink-0">
            <div class="flex flex-col gap-2">
                <div class="flex gap-2 items-center">
                    <input type="file" id="fileUpload" accept=".csv, .xlsx, .xls" class="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-xs file:font-bold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700 cursor-pointer bg-white border border-indigo-200 rounded-md"/>
                    <button onclick="startProcessing()" class="bg-indigo-600 text-white p-2 rounded-md hover:bg-indigo-700 shadow-sm active:scale-95 transition" title="Import Now">
                        <span class="font-bold text-xs">GO</span>
                    </button>
                </div>
                
                <div id="statusBox" class="hidden mt-2 p-2 rounded text-xs font-mono break-words"></div>
            </div>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-2 divide-x divide-slate-100 border-b bg-white shrink-0 shadow-sm z-10">
            <div class="p-3 text-center">
                <div class="text-2xl font-black text-slate-700" id="countTotal">0</div>
                <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Total Files</div>
            </div>
            <div class="p-3 text-center">
                <div class="text-2xl font-black text-orange-600" id="countPending">0</div>
                <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Pending Return</div>
            </div>
        </div>

        <!-- Search -->
        <div class="p-2 bg-slate-50 border-b shrink-0">
            <input type="text" id="searchInput" oninput="debounceRender()" placeholder="Search File No or Case No..." class="w-full px-4 py-2 bg-white border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 transition shadow-sm">
        </div>

        <!-- List View -->
        <div class="flex-1 overflow-y-auto bg-slate-50 relative" id="fileList">
            <!-- Content Injected Here -->
        </div>

        <!-- Export Footer -->
        <div class="p-4 bg-white border-t shrink-0 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-20">
            <button onclick="exportPending()" class="w-full flex justify-center items-center gap-2 bg-emerald-600 text-white py-3 rounded-xl font-bold hover:bg-emerald-700 transition shadow active:scale-[0.98]">
                <span>â¬‡ Download Pending Report</span>
            </button>
        </div>
    </div>

    <script>
        // --- 1. CRITICAL: Initialize Database FIRST ---
        // We declare 'db' here at the very top so it is available to ALL functions below.
        let db = [];
        try {
            const savedData = localStorage.getItem('legalTrackerV4');
            if (savedData) {
                db = JSON.parse(savedData);
            }
        } catch (e) {
            console.error("Error loading saved data:", e);
            db = [];
        }

        // --- 2. Initial Render ---
        // Run immediately to show any saved data
        document.addEventListener('DOMContentLoaded', () => {
             renderList();
             // Try to load icons if library exists
             if (typeof lucide !== 'undefined') {
                 lucide.createIcons();
                 document.getElementById('headerIcon').innerHTML = '<i data-lucide="scale" class="w-5 h-5"></i>';
                 lucide.createIcons();
             }
        });

        // --- 3. Core Functions ---

        function showStatus(msg, type = 'info') {
            const el = document.getElementById('statusBox');
            el.classList.remove('hidden', 'bg-red-50', 'text-red-700', 'bg-indigo-50', 'text-indigo-700', 'bg-green-50', 'text-green-700');
            
            if (type === 'error') el.classList.add('bg-red-50', 'text-red-700');
            else if (type === 'success') el.classList.add('bg-green-50', 'text-green-700');
            else el.classList.add('bg-indigo-50', 'text-indigo-700');
            
            el.textContent = msg;
        }

        function startProcessing() {
            const fileInput = document.getElementById('fileUpload');
            if(!fileInput.files.length) { 
                showStatus("Please select a file first.", "error");
                return;
            }
            
            showStatus("Reading file...", "info");
            
            setTimeout(() => {
                const file = fileInput.files[0];
                const isCSV = file.name.toLowerCase().endsWith('.csv');
                
                // Fallback to text reader immediately if it's a CSV to avoid library issues
                if (isCSV) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const text = e.target.result;
                            const jsonData = parseCSVFallback(text);
                            processData(jsonData);
                        } catch (err) {
                            showStatus("CSV Error: " + err.message, "error");
                        }
                    };
                    reader.readAsText(file); // Safe for CSV
                    return;
                }

                // If Excel (xlsx), try to use the library
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        if (typeof XLSX === 'undefined') throw new Error("Excel library not loaded. Please use CSV file.");
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                        processData(jsonData);
                    } catch (err) {
                        showStatus("Error: " + err.message, "error");
                    }
                };
                reader.readAsArrayBuffer(file);

            }, 50);
        }

        function parseCSVFallback(text) {
            // Robust CSV Splitter
            const lines = text.split(/\r\n|\n/);
            return lines.map(line => {
                // If line contains quotes, use regex, otherwise simple split
                if (line.includes('"')) {
                     const matches = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                     return matches ? matches.map(m => m.replace(/^"|"$/g, '')) : line.split(',');
                }
                return line.split(',');
            });
        }

        function processData(rows) {
            if (!rows || rows.length === 0) {
                showStatus("File is empty.", "error");
                return;
            }

            let importedCount = 0;
            const importDate = new Date().toLocaleDateString();
            
            // Create signature set from GLOBAL db
            const existingSignatures = new Set(db.map(i => i.caseNo + '|' + i.importDate));
            const newItems = [];
            
            // 1. Auto-Detect Column (Scanning for format "WPC 123/24")
            const casePattern = /[A-Z]+\s*\d{1,6}\/\d{2,4}/i; 
            let bestCol = 1; // Default to Column B
            let maxScore = 0;
            const scores = {};
            
            // Scan first 50 rows
            const limit = Math.min(rows.length, 50);
            for(let r=0; r<limit; r++) {
                const row = rows[r];
                if(Array.isArray(row)) {
                    row.forEach((cell, idx) => {
                        if (cell && typeof cell === 'string' && casePattern.test(cell)) {
                            scores[idx] = (scores[idx] || 0) + 1;
                        }
                    });
                }
            }
            
            for (const [col, score] of Object.entries(scores)) {
                if (score > maxScore) { maxScore = score; bestCol = parseInt(col); }
            }

            // 2. Extract Data
            rows.forEach(row => {
                if (!Array.isArray(row)) return;
                
                let rawCase = row[bestCol];
                if (isValidCase(rawCase)) {
                    const caseNo = rawCase.trim();
                    const uniqueKey = caseNo + '|' + importDate;
                    
                    if (!existingSignatures.has(uniqueKey)) {
                        // Try to get details from adjacent columns
                        let details = row[bestCol + 1] || row[bestCol - 1] || "";
                        if (typeof details !== 'string') details = String(details);

                        // Extract FILE NO (Usually 2 columns after Case No based on provided sheet)
                        let fileNo = row[bestCol + 2] || "";
                        if (typeof fileNo !== 'string') fileNo = String(fileNo);
                        fileNo = fileNo.trim();
                        
                        newItems.push({
                            id: Date.now() + Math.random(),
                            caseNo: caseNo,
                            fileNo: fileNo, // Store File No
                            details: details.replace('(Revenue)', '').replace(/\s+/g, ' ').trim().substring(0, 50),
                            importDate: importDate,
                            status: 'sent',
                            timestamp: Date.now()
                        });
                        
                        existingSignatures.add(uniqueKey);
                        importedCount++;
                    }
                }
            });

            if (newItems.length > 0) {
                // Update GLOBAL db
                db = [...db, ...newItems];
                saveData();
                renderList();
                showStatus(`Success! Added ${importedCount} files.`, "success");
                document.getElementById('fileUpload').value = '';
            } else {
                showStatus(`No new files found. (Scanned Column ${bestCol+1})`, "error");
            }
        }

        function isValidCase(str) {
            if (!str || typeof str !== 'string' || str.length < 5) return false;
            // Must have a slash (e.g. 123/24)
            if (!str.includes('/')) return false;
            const upper = str.toUpperCase();
            // Ignore Header rows
            if (upper.includes('JUSTICE') || upper.includes('HON') || upper.includes('DATE')) return false;
            return true;
        }

        let renderTimeout;
        function debounceRender() {
            clearTimeout(renderTimeout);
            renderTimeout = setTimeout(renderList, 300);
        }

        function renderList() {
            const listContainer = document.getElementById('fileList');
            const countTotal = document.getElementById('countTotal');
            const countPending = document.getElementById('countPending');
            const filterText = document.getElementById('searchInput').value.toLowerCase();
            
            // Sort: Pending files first, then by date
            const displayList = db
                .filter(item => 
                    !filterText || 
                    item.caseNo.toLowerCase().includes(filterText) ||
                    (item.fileNo && item.fileNo.toLowerCase().includes(filterText))
                )
                .sort((a, b) => {
                    if (a.status === b.status) return b.timestamp - a.timestamp;
                    return a.status === 'sent' ? -1 : 1;
                });

            const pendingCount = db.filter(i => i.status === 'sent').length;

            if (displayList.length === 0) {
                listContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-slate-400 p-10">
                        <span class="text-4xl opacity-20">ðŸ“‚</span>
                        <p class="mt-2 text-sm">No files found</p>
                    </div>`;
            } else {
                // Limit to 200 items for performance
                const visibleItems = displayList.slice(0, 200); 
                
                listContainer.innerHTML = visibleItems.map(item => {
                    const isReturned = item.status === 'returned';
                    // Check if fileNo exists to display it
                    const fileBadge = item.fileNo 
                        ? `<span class="ml-2 bg-indigo-100 text-indigo-700 text-[10px] px-1.5 py-0.5 rounded font-mono border border-indigo-200">#${item.fileNo}</span>` 
                        : '';

                    return `
                    <div class="group p-3 border-b bg-white hover:bg-slate-50 transition flex justify-between items-center gap-3">
                        <div class="flex-1 overflow-hidden">
                            <div class="flex items-center flex-wrap gap-1 mb-0.5">
                                <span class="font-bold text-sm text-slate-800 ${isReturned ? 'line-through text-slate-400' : ''}">
                                    ${item.caseNo}
                                </span>
                                ${fileBadge}
                                ${!isReturned ? '<span class="w-2 h-2 rounded-full bg-orange-500 animate-pulse ml-auto"></span>' : ''}
                            </div>
                            <div class="text-[10px] text-slate-500 truncate mt-0.5">
                                ${item.importDate} â€¢ ${item.details}
                            </div>
                        </div>
                        <button onclick="toggleStatus(${item.id})" 
                            class="shrink-0 px-3 py-1.5 rounded-md text-[10px] uppercase font-bold tracking-wide transition shadow-sm
                            ${isReturned 
                                ? 'bg-slate-100 text-slate-400 border border-slate-200 hover:bg-slate-200' 
                                : 'bg-white text-orange-600 border border-orange-200 hover:bg-orange-50 hover:border-orange-300'}">
                            ${isReturned ? 'Undo' : 'Return'}
                        </button>
                    </div>
                `}).join('');
            }
            
            countTotal.innerText = db.length;
            countPending.innerText = pendingCount;
            
            // Try to re-render icons if library loaded late
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function toggleStatus(id) {
            const index = db.findIndex(x => x.id === id);
            if (index !== -1) {
                db[index].status = db[index].status === 'sent' ? 'returned' : 'sent';
                saveData();
                renderList();
            }
        }

        function exportPending() {
            const pendingItems = db.filter(item => item.status === 'sent');
            if (pendingItems.length === 0) { alert("Nothing to export!"); return; }
            
            // CSV Export logic (Works without external libraries)
            let csvContent = "data:text/csv;charset=utf-8,Case No,File No,Date,Details\n";
            pendingItems.forEach(row => {
                // Escape commas in data
                const safeDetails = row.details.replace(/,/g, ' ');
                // Add FileNo to CSV
                csvContent += `${row.caseNo},${row.fileNo || ''},${row.importDate},${safeDetails}\n`;
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Pending_Files_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function saveData() { 
            try { 
                localStorage.setItem('legalTrackerV4', JSON.stringify(db)); 
            } catch (e) { 
                alert("Storage full! Please reset some data."); 
            } 
        }

        function clearData() { 
            if(confirm("Delete ALL history? This cannot be undone.")) { 
                db = []; 
                saveData(); 
                renderList(); 
            } 
        }
    </script>
</body>
</html>