<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Legal File Tracker v5 (Stable)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .slide-in { animation: slideIn 0.2s ease-out; }
        @keyframes slideIn { from { transform: translateY(5px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        /* Custom Scrollbar for list */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-100 h-screen w-full flex items-center justify-center p-2 md:p-6 overflow-hidden text-slate-800">

    <!-- App Container: Centered, responsive height, fixed max-width -->
    <div class="w-full max-w-xl bg-white shadow-xl rounded-2xl border border-slate-200 flex flex-col h-full max-h-[90vh] overflow-hidden relative">
        
        <!-- Header -->
        <div class="bg-indigo-900 p-4 text-white flex justify-between items-center shadow-md shrink-0 z-20">
            <div>
                <h1 class="text-lg font-bold tracking-wide flex items-center gap-2">
                    <span id="headerIcon">ðŸ“‚</span> Legal Tracker
                </h1>
                <p class="text-indigo-200 text-[10px] uppercase tracking-wider">Stable Version v5</p>
            </div>
            <button onclick="confirmClearData()" class="text-xs bg-indigo-800 hover:bg-red-500 text-white px-3 py-1.5 rounded transition-colors duration-200 border border-indigo-700">Reset All</button>
        </div>

        <!-- Import Section -->
        <div class="p-4 bg-indigo-50 border-b border-indigo-100 shrink-0 z-10">
            <div class="flex flex-col gap-2">
                <div class="flex gap-2 items-center">
                    <input type="file" id="fileUpload" accept=".csv, .xlsx, .xls" class="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-xs file:font-bold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700 cursor-pointer bg-white border border-indigo-200 rounded-md shadow-sm"/>
                    <button onclick="startProcessing()" class="bg-indigo-600 text-white p-2 rounded-md hover:bg-indigo-700 shadow-sm active:scale-95 transition flex items-center justify-center w-10 shrink-0" title="Import Now">
                        <span class="font-bold text-xs">GO</span>
                    </button>
                </div>
                
                <div id="statusBox" class="hidden mt-2 p-2 rounded text-xs font-mono break-words transition-all duration-300"></div>
            </div>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-2 divide-x divide-slate-100 border-b bg-white shrink-0 shadow-sm z-10">
            <div class="p-3 text-center">
                <div class="text-2xl font-black text-slate-700" id="countTotal">0</div>
                <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Total Files</div>
            </div>
            <div class="p-3 text-center">
                <div class="text-2xl font-black text-orange-600" id="countPending">0</div>
                <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Pending Return</div>
            </div>
        </div>

        <!-- Search -->
        <div class="p-2 bg-slate-50 border-b shrink-0 z-10">
            <input type="text" id="searchInput" oninput="debounceRender()" placeholder="Search File No or Case No..." class="w-full px-4 py-2 bg-white border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 transition shadow-sm">
        </div>

        <!-- List View -->
        <div class="flex-1 overflow-y-auto bg-slate-50 relative scroll-smooth" id="fileList">
            <!-- Content Injected Here -->
        </div>

        <!-- Export Footer -->
        <div class="p-4 bg-white border-t shrink-0 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-20">
            <button onclick="exportPending()" class="w-full flex justify-center items-center gap-2 bg-emerald-600 text-white py-3 rounded-xl font-bold hover:bg-emerald-700 transition shadow active:scale-[0.98]">
                <span>â¬‡ Download Pending Report</span>
            </button>
        </div>

        <!-- Custom Confirmation Modal (Inside container to ensure visibility) -->
        <div id="confirmModal" class="absolute inset-0 bg-black/60 hidden items-center justify-center z-50 backdrop-blur-sm transition-opacity opacity-0 pointer-events-none" style="transition: opacity 0.2s;">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-[85%] w-full transform scale-95 transition-transform border border-slate-100" id="confirmModalContent">
                <h3 class="text-lg font-bold mb-2 text-slate-800">Confirm Action</h3>
                <p id="confirmMessage" class="text-slate-600 mb-6 text-sm">Are you sure you want to proceed?</p>
                <div class="flex justify-end gap-3">
                    <button onclick="closeConfirm()" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded text-sm font-medium transition-colors">Cancel</button>
                    <button id="confirmYesBtn" class="px-4 py-2 bg-red-600 text-white hover:bg-red-700 rounded text-sm font-medium shadow-sm transition-colors">Confirm</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- 1. CRITICAL: Initialize Database FIRST ---
        let db = [];
        try {
            const savedData = localStorage.getItem('legalTrackerV4');
            if (savedData) {
                db = JSON.parse(savedData);
            }
        } catch (e) {
            console.error("Error loading saved data:", e);
            db = [];
        }

        // --- 2. Initial Render & CLEANUP ---
        document.addEventListener('DOMContentLoaded', () => {
             // MIGRATION 1: Fix numeric IDs to Strings
             let dataFixed = false;
             db = db.map(item => {
                if (typeof item.id === 'number') {
                    item.id = "id_" + String(item.id).replace('.', '_'); 
                    dataFixed = true;
                }
                return item;
             });
             
             // MIGRATION 2: REMOVE files with no File Number (As requested)
             const originalLength = db.length;
             db = db.filter(item => item.fileNo && item.fileNo.toString().trim() !== '');
             if (db.length !== originalLength) {
                 dataFixed = true;
             }
             
             if (dataFixed) saveData(); // Save changes permanently

             renderList();
             
             if (typeof lucide !== 'undefined') {
                 lucide.createIcons();
                 document.getElementById('headerIcon').innerHTML = '<i data-lucide="scale" class="w-5 h-5"></i>';
                 lucide.createIcons();
             }
        });

        // --- 3. Core Functions ---

        function generateId() {
            return 'id_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        function showStatus(msg, type = 'info') {
            const el = document.getElementById('statusBox');
            el.classList.remove('hidden', 'bg-red-50', 'text-red-700', 'bg-indigo-50', 'text-indigo-700', 'bg-green-50', 'text-green-700');
            
            if (type === 'error') el.classList.add('bg-red-50', 'text-red-700');
            else if (type === 'success') el.classList.add('bg-green-50', 'text-green-700');
            else el.classList.add('bg-indigo-50', 'text-indigo-700');
            
            el.textContent = msg;
            el.classList.remove('hidden');
        }

        function startProcessing() {
            const fileInput = document.getElementById('fileUpload');
            if(!fileInput.files.length) { 
                showStatus("Please select a file first.", "error");
                return;
            }
            
            showStatus("Reading file...", "info");
            
            setTimeout(() => {
                const file = fileInput.files[0];
                const isCSV = file.name.toLowerCase().endsWith('.csv');
                
                if (isCSV) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const text = e.target.result;
                            const jsonData = parseCSVFallback(text);
                            processData(jsonData);
                        } catch (err) {
                            showStatus("CSV Error: " + err.message, "error");
                        }
                    };
                    reader.readAsText(file); 
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        if (typeof XLSX === 'undefined') throw new Error("Excel library not loaded. Please use CSV file.");
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                        processData(jsonData);
                    } catch (err) {
                        showStatus("Error: " + err.message, "error");
                    }
                };
                reader.readAsArrayBuffer(file);

            }, 50);
        }

        function parseCSVFallback(text) {
            const lines = text.split(/\r\n|\n/);
            return lines.map(line => {
                if (line.includes('"')) {
                     const matches = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                     return matches ? matches.map(m => m.replace(/^"|"$/g, '')) : line.split(',');
                }
                return line.split(',');
            });
        }

        function processData(rows) {
            if (!rows || rows.length === 0) {
                showStatus("File is empty.", "error");
                return;
            }

            let importedCount = 0;
            let skippedNoFileNo = 0;
            let skippedInvalidCase = 0;
            const importDate = new Date().toLocaleDateString();
            
            const existingSignatures = new Set(db.map(i => i.caseNo + '|' + i.importDate));
            const newItems = [];
            
            // Auto-Detect Column logic
            const casePattern = /[A-Z]+\s*\d{1,6}\/\d{2,4}/i; 
            let bestCol = 1; 
            let maxScore = 0;
            const scores = {};
            
            const limit = Math.min(rows.length, 50);
            for(let r=0; r<limit; r++) {
                const row = rows[r];
                if(Array.isArray(row)) {
                    row.forEach((cell, idx) => {
                        if (cell && typeof cell === 'string' && casePattern.test(cell)) {
                            scores[idx] = (scores[idx] || 0) + 1;
                        }
                    });
                }
            }
            
            for (const [col, score] of Object.entries(scores)) {
                if (score > maxScore) { maxScore = score; bestCol = parseInt(col); }
            }

            rows.forEach(row => {
                if (!Array.isArray(row)) return;
                
                let rawCase = row[bestCol];
                if (isValidCase(rawCase)) {
                    const caseNo = rawCase.trim();
                    const uniqueKey = caseNo + '|' + importDate;
                    
                    if (!existingSignatures.has(uniqueKey)) {
                        let details = row[bestCol + 1] || row[bestCol - 1] || "";
                        if (typeof details !== 'string') details = String(details);

                        // Improved File No Extraction (Handles 0 correctly)
                        let fileNo = row[bestCol + 2];
                        if (fileNo === undefined || fileNo === null) fileNo = "";
                        fileNo = String(fileNo).trim();
                        
                        // STRICT FILTER: Ignore imports without File No
                        if (!fileNo || fileNo === "") {
                            skippedNoFileNo++;
                            return;
                        }

                        newItems.push({
                            id: generateId(),
                            caseNo: caseNo,
                            fileNo: fileNo, 
                            details: details.replace('(Revenue)', '').replace(/\s+/g, ' ').trim().substring(0, 50),
                            importDate: importDate,
                            status: 'sent',
                            timestamp: Date.now()
                        });
                        
                        existingSignatures.add(uniqueKey);
                        importedCount++;
                    }
                } else {
                    // Just tracking for debugging, usually headers or invalid rows
                    if(row.some(cell => cell)) skippedInvalidCase++; 
                }
            });

            if (newItems.length > 0) {
                db = [...db, ...newItems];
                saveData();
                renderList();
                let msg = `Success! Added ${importedCount} files.`;
                if (skippedNoFileNo > 0) msg += ` (Skipped ${skippedNoFileNo} missing File Nos)`;
                showStatus(msg, "success");
                document.getElementById('fileUpload').value = '';
            } else {
                let msg = "No new files added.";
                if (skippedNoFileNo > 0) msg += ` Skipped ${skippedNoFileNo} items due to missing File Numbers.`;
                else msg += ` (Scanned Col ${bestCol+1})`;
                showStatus(msg, "error");
            }
        }

        function isValidCase(str) {
            if (!str || typeof str !== 'string' || str.length < 5) return false;
            if (!str.includes('/')) return false;
            const upper = str.toUpperCase();
            if (upper.includes('JUSTICE') || upper.includes('HON') || upper.includes('DATE')) return false;
            return true;
        }

        let renderTimeout;
        function debounceRender() {
            clearTimeout(renderTimeout);
            renderTimeout = setTimeout(renderList, 300);
        }

        function renderList() {
            const listContainer = document.getElementById('fileList');
            const countTotal = document.getElementById('countTotal');
            const countPending = document.getElementById('countPending');
            const filterText = document.getElementById('searchInput').value.toLowerCase();
            
            const displayList = db
                .filter(item => 
                    !filterText || 
                    item.caseNo.toLowerCase().includes(filterText) ||
                    (item.fileNo && item.fileNo.toLowerCase().includes(filterText))
                )
                .sort((a, b) => {
                    // 1. Sort by Status (Pending/Sent first)
                    if (a.status !== b.status) return a.status === 'sent' ? -1 : 1;
                    
                    // 2. Sort by File No (Numeric)
                    const numA = parseFloat(a.fileNo) || 0;
                    const numB = parseFloat(b.fileNo) || 0;
                    return numA - numB;
                });

            const pendingCount = db.filter(i => i.status === 'sent').length;

            if (displayList.length === 0) {
                listContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-slate-400 p-10 select-none">
                        <span class="text-4xl opacity-20">ðŸ“‚</span>
                        <p class="mt-2 text-sm">No files found</p>
                    </div>`;
            } else {
                const visibleItems = displayList.slice(0, 200); 
                
                listContainer.innerHTML = visibleItems.map(item => {
                    const isReturned = item.status === 'returned';
                    const fileBadge = `<span class="ml-2 bg-indigo-100 text-indigo-700 text-[10px] px-1.5 py-0.5 rounded font-mono border border-indigo-200">#${item.fileNo}</span>`;
                    
                    const buttonStyle = isReturned 
                        ? 'bg-slate-100 text-slate-400 border border-slate-200 hover:bg-slate-200' 
                        : 'bg-white text-orange-600 border border-orange-200 hover:bg-orange-50 hover:border-orange-300';

                    return `
                    <div class="group p-3 border-b bg-white hover:bg-slate-50 transition flex justify-between items-center gap-3 slide-in">
                        <div class="flex-1 overflow-hidden">
                            <div class="flex items-center flex-wrap gap-1 mb-0.5">
                                <span class="font-bold text-sm text-slate-800 ${isReturned ? 'line-through text-slate-400' : ''}">
                                    ${item.caseNo}
                                </span>
                                ${fileBadge}
                                ${!isReturned ? '<span class="w-2 h-2 rounded-full bg-orange-500 animate-pulse ml-auto"></span>' : ''}
                            </div>
                            <div class="text-[10px] text-slate-500 truncate mt-0.5">
                                ${item.importDate} â€¢ ${item.details}
                            </div>
                        </div>
                        <button onclick="toggleStatus('${item.id}')" 
                            class="shrink-0 px-3 py-1.5 rounded-md text-[10px] uppercase font-bold tracking-wide transition shadow-sm ${buttonStyle}">
                            ${isReturned ? 'Undo' : 'Return'}
                        </button>
                    </div>
                `}).join('');
            }
            
            countTotal.innerText = db.length;
            countPending.innerText = pendingCount;
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function toggleStatus(id) {
            const index = db.findIndex(x => String(x.id) === String(id));
            if (index !== -1) {
                db[index].status = db[index].status === 'sent' ? 'returned' : 'sent';
                saveData();
                renderList();
            } else {
                console.error("ID Not Found:", id);
            }
        }

        function exportPending() {
            const pendingItems = db.filter(item => item.status === 'sent');
            if (pendingItems.length === 0) { 
                showStatus("Nothing to export!", "error"); 
                return; 
            }
            
            let csvContent = "data:text/csv;charset=utf-8,Case No,File No,Date,Details\n";
            pendingItems.forEach(row => {
                const safeDetails = row.details.replace(/,/g, ' ');
                csvContent += `${row.caseNo},${row.fileNo || ''},${row.importDate},${safeDetails}\n`;
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Pending_Files_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function saveData() { 
            try { 
                localStorage.setItem('legalTrackerV4', JSON.stringify(db)); 
            } catch (e) { 
                showStatus("Storage full! Please reset some data.", "error"); 
            } 
        }

        function confirmClearData() { 
            showConfirm("Delete ALL history? This cannot be undone.", () => {
                db = []; 
                saveData(); 
                renderList(); 
                showStatus("History cleared.", "success");
            });
        }
        
        function showConfirm(msg, onYes) {
            const modal = document.getElementById('confirmModal');
            const modalContent = document.getElementById('confirmModalContent');
            const msgEl = document.getElementById('confirmMessage');
            const yesBtn = document.getElementById('confirmYesBtn');
            
            msgEl.textContent = msg;
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0', 'pointer-events-none');
                modalContent.classList.remove('scale-95');
                modalContent.classList.add('scale-100');
            }, 10);
            
            const newYesBtn = yesBtn.cloneNode(true);
            yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);
            
            newYesBtn.addEventListener('click', () => {
                onYes();
                closeConfirm();
            });
        }

        function closeConfirm() {
            const modal = document.getElementById('confirmModal');
            const modalContent = document.getElementById('confirmModalContent');
            
            modal.classList.add('opacity-0', 'pointer-events-none');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200);
        }
    </script>
</body>
</html>
